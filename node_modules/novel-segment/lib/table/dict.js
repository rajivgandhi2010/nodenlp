"use strict";
/**
 * Created by user on 2018/4/15/015.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const segment_1 = require("segment-dict/lib/loader/segment");
const cjk_1 = require("../util/cjk");
const core_1 = require("./core");
const util_1 = require("../util");
/**
 * @todo 掛接其他 dict
 */
class TableDict extends core_1.default {
    constructor() {
        super(...arguments);
        this.TABLE = {};
        this.TABLE2 = {};
    }
    exists(data) {
        let w, p, f;
        if (typeof data == 'string') {
            w = data;
        }
        else if (Array.isArray(data)) {
            [w, p, f] = data;
        }
        else {
            ({ w, p, f } = data);
        }
        return this.TABLE[w] || null;
    }
    __handleInput(data) {
        let w, p, f;
        let plus;
        if (typeof data == 'string') {
            w = data;
        }
        else if (Array.isArray(data)) {
            [w, p, f, ...plus] = data;
        }
        else {
            ({ w, p, f } = data);
        }
        if (typeof w !== 'string' || w === '') {
            throw new TypeError(JSON.stringify(data));
        }
        p = (typeof p != 'number' || Number.isNaN(p)) ? 0 : p;
        f = (typeof f != 'number' || Number.isNaN(f)) ? 0 : f;
        return {
            data: {
                w, p, f,
            },
            plus,
        };
    }
    add(data, skipExists) {
        let w, p, f;
        let plus;
        {
            let ret = this.__handleInput(data);
            ({ w, p, f } = ret.data);
            plus = ret.plus;
        }
        if (skipExists && this.exists(w)) {
            return this;
        }
        if (plus && plus.length) {
            // @todo do something
        }
        this._add({ w, p, f, s: true });
        let self = this;
        /**
         * @todo 需要更聰明的作法 目前的做法實在太蠢
         * @BUG 在不明原因下 似乎不會正確的添加每個項目 如果遇到這種情形請手動添加簡繁項目
         */
        if (1 && this.options.autoCjk) {
            let wa = cjk_1.text_list(w);
            wa.forEach(function (w2) {
                if (w2 != w && !self.exists(w2)) {
                    self._add({ w: w2, p, f });
                }
            });
            /*
            let w2: string;
            w2 = CjkConv.zh2jp(w);

            if (w2 != w && !this.exists(w2))
            {
                this._add({w: w2, p, f});
                //console.log(w2);
            }

            w2 = CjkConv.cjk2zht(w);

            if (w2 !== w && !this.exists(w2))
            {
                this._add({w: w2, p, f});
                //console.log(w2);
            }

            w2 = CjkConv.cjk2zhs(w);

            if (w2 !== w && !this.exists(w2))
            {
                this._add({w: w2, p, f});
                //console.log(w2);
            }
            */
        }
        return this;
    }
    _add({ w, p, f, s }) {
        let len = w.length;
        this.TABLE[w] = {
            p,
            f,
            s,
        };
        if (!this.TABLE2[len])
            this.TABLE2[len] = {};
        this.TABLE2[len][w] = this.TABLE[w];
    }
    remove(target) {
        let { data, plus } = this.__handleInput(target);
        this._remove(data);
        return this;
    }
    _remove({ w, p, f, s }) {
        let len = w.length;
        delete this.TABLE[w];
        if (this.TABLE2[len]) {
            delete this.TABLE2[len][w];
        }
        return this;
    }
    json() {
        return util_1.cloneDeep(this.TABLE);
    }
    /**
     * 將目前的 表格 匯出
     */
    stringify(LF = "\n") {
        let self = this;
        return Object.entries(self.TABLE)
            .reduce(function (a, [w, { p, f }]) {
            let line = segment_1.stringifyLine([w, p, f]);
            a.push(line);
            return a;
        }, [])
            .join(typeof LF === 'string' ? LF : "\n");
    }
}
exports.TableDict = TableDict;
exports.default = TableDict;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGljdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImRpY3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOztHQUVHOztBQUdILDZEQUFxRjtBQUVyRixxQ0FBd0M7QUFDeEMsaUNBQXdFO0FBQ3hFLGtDQUFvQztBQVlwQzs7R0FFRztBQUNILE1BQWEsU0FBVSxTQUFRLGNBQW9DO0lBQW5FOztRQUlDLFVBQUssR0FBeUIsRUFBRSxDQUFDO1FBQ2pDLFdBQU0sR0FBMEIsRUFBRSxDQUFDO0lBcU1wQyxDQUFDO0lBak1BLE1BQU0sQ0FBQyxJQUErQjtRQUVyQyxJQUFJLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBRVosSUFBSSxPQUFPLElBQUksSUFBSSxRQUFRLEVBQzNCO1lBQ0MsQ0FBQyxHQUFHLElBQUksQ0FBQztTQUNUO2FBQ0ksSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUM1QjtZQUNDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUM7U0FDakI7YUFFRDtZQUNDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDO1NBQ3JCO1FBRUQsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxJQUFJLElBQUksQ0FBQztJQUM5QixDQUFDO0lBRVMsYUFBYSxDQUFDLElBQStCO1FBRXRELElBQUksQ0FBUyxFQUFFLENBQVMsRUFBRSxDQUFTLENBQUM7UUFDcEMsSUFBSSxJQUE0QixDQUFDO1FBRWpDLElBQUksT0FBTyxJQUFJLElBQUksUUFBUSxFQUMzQjtZQUNDLENBQUMsR0FBRyxJQUFJLENBQUM7U0FDVDthQUNJLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFDNUI7WUFDQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDLEdBQUcs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QyxJQUFJLENBQUMsQ0FBQztZQUViLE9BQU8sQ0FBQyxDQUFBO1FBQ1QsQ0FBQyxFQUFFLEVBQUUsQ0FBQzthQUNMLElBQUksQ0FBQyxPQUFPLEVBQUUsS0FBSyxRQUFRLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQ3hDO0lBQ0gsQ0FBQztDQUNEO0FBMU1ELDhCQTBNQztBQUVELGtCQUFlLFNBQVMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ3JlYXRlZCBieSB1c2VyIG9uIDIwMTgvNC8xNS8wMTUuXG4gKi9cblxuaW1wb3J0IHsgSVdvcmQgfSBmcm9tICcuLi9TZWdtZW50JztcbmltcG9ydCB7IElEaWN0Um93LCBzZXJpYWxpemUsIHN0cmluZ2lmeUxpbmUgfSBmcm9tICdzZWdtZW50LWRpY3QvbGliL2xvYWRlci9zZWdtZW50JztcbmltcG9ydCBDamtDb252IGZyb20gJ2Nqay1jb252JztcbmltcG9ydCB7IHRleHRfbGlzdCB9IGZyb20gJy4uL3V0aWwvY2prJztcbmltcG9ydCBBYnN0cmFjdFRhYmxlRGljdENvcmUsIHsgSURJQ1QsIElESUNUMiwgSU9wdGlvbnMgfSBmcm9tICcuL2NvcmUnO1xuaW1wb3J0IHsgY2xvbmVEZWVwIH0gZnJvbSAnLi4vdXRpbCc7XG5cbmRlY2xhcmUgZnVuY3Rpb24gX2Nsb25lRGVlcDxUPihkYXRhOiBUKTogVFxuXG5leHBvcnQgdHlwZSBJVGFibGVEaWN0Um93ID0ge1xuXHRwOiBudW1iZXIsXG5cdGY6IG51bWJlcixcblx0cz86IGJvb2xlYW4sXG59O1xuXG5leHBvcnQgeyBJRElDVCwgSURJQ1QyLCBJT3B0aW9ucyB9XG5cbi8qKlxuICogQHRvZG8g5o6b5o6l5YW25LuWIGRpY3RcbiAqL1xuZXhwb3J0IGNsYXNzIFRhYmxlRGljdCBleHRlbmRzIEFic3RyYWN0VGFibGVEaWN0Q29yZTxJVGFibGVEaWN0Um93Plxue1xuXHRwdWJsaWMgdHlwZTogc3RyaW5nO1xuXG5cdFRBQkxFOiBJRElDVDxJVGFibGVEaWN0Um93PiA9IHt9O1xuXHRUQUJMRTI6IElESUNUMjxJVGFibGVEaWN0Um93PiA9IHt9O1xuXG5cdG9wdGlvbnM6IElPcHRpb25zO1xuXG5cdGV4aXN0cyhkYXRhOiBJV29yZCB8IElEaWN0Um93IHwgc3RyaW5nKTogSVRhYmxlRGljdFJvd1xuXHR7XG5cdFx0bGV0IHcsIHAsIGY7XG5cblx0XHRpZiAodHlwZW9mIGRhdGEgPT0gJ3N0cmluZycpXG5cdFx0e1xuXHRcdFx0dyA9IGRhdGE7XG5cdFx0fVxuXHRcdGVsc2UgaWYgKEFycmF5LmlzQXJyYXkoZGF0YSkpXG5cdFx0e1xuXHRcdFx0W3csIHAsIGZdID0gZGF0YTtcblx0XHR9XG5cdFx0ZWxzZVxuXHRcdHtcblx0XHRcdCh7IHcsIHAsIGYgfSA9IGRhdGEpO1xuXHRcdH1cblxuXHRcdHJldHVybiB0aGlzLlRBQkxFW3ddIHx8IG51bGw7XG5cdH1cblxuXHRwcm90ZWN0ZWQgX19oYW5kbGVJbnB1dChkYXRhOiBJV29yZCB8IElEaWN0Um93IHwgc3RyaW5nKVxuXHR7XG5cdFx0bGV0IHc6IHN0cmluZywgcDogbnVtYmVyLCBmOiBudW1iZXI7XG5cdFx0bGV0IHBsdXM6IEFycmF5PHN0cmluZyB8IG51bWJlcj47XG5cblx0XHRpZiAodHlwZW9mIGRhdGEgPT0gJ3N0cmluZycpXG5cdFx0e1xuXHRcdFx0dyA9IGRhdGE7XG5cdFx0fVxuXHRcdGVsc2UgaWYgKEFycmF5LmlzQXJyYXkoZGF0YSkpXG5cdFx0e1xuXHRcdFx0W3csIHAsIGYsIC4uLnBsdXNdID0gZGF0YTtcblx0XHR9XG5cdFx0ZWxzZVxuXHRcdHtcblx0XHRcdCh7IHcsIHAsIGYgfSA9IGRhdGEpO1xuXHRcdH1cblxuXHRcdGlmICh0eXBlb2YgdyAhPT0gJ3N0cmluZycgfHwgdyA9PT0gJycpXG5cdFx0e1xuXHRcdFx0dGhyb3cgbmV3IFR5cGVFcnJvcihKU09OLnN0cmluZ2lmeShkYXRhKSk7XG5cdFx0fVxuXG5cdFx0cCA9ICh0eXBlb2YgcCAhPSAnbnVtYmVyJyB8fCBOdW1iZXIuaXNOYU4ocCkpID8gMCA6IHA7XG5cdFx0ZiA9ICh0eXBlb2YgZiAhPSAnbnVtYmVyJyB8fCBOdW1iZXIuaXNOYU4oZikpID8gMCA6IGY7XG5cblx0XHRyZXR1cm4ge1xuXHRcdFx0ZGF0YToge1xuXHRcdFx0XHR3LCBwLCBmLFxuXHRcdFx0fSxcblx0XHRcdHBsdXMsXG5cdFx0fVxuXHR9XG5cblx0YWRkKGRhdGE6IElXb3JkIHwgSURpY3RSb3cgfCBzdHJpbmcsIHNraXBFeGlzdHM/OiBib29sZWFuKVxuXHR7XG5cdFx0bGV0IHc6IHN0cmluZywgcDogbnVtYmVyLCBmOiBudW1iZXI7XG5cdFx0bGV0IHBsdXM6IEFycmF5PHN0cmluZyB8IG51bWJlcj47XG5cblx0XHR7XG5cdFx0XHRsZXQgcmV0ID0gdGhpcy5fX2hhbmRsZUlucHV0KGRhdGEpO1xuXG5cdFx0XHQoeyB3LCBwLCBmIH0gPSByZXQuZGF0YSk7XG5cdFx0XHRwbHVzID0gcmV0LnBsdXM7XG5cdFx0fVxuXG5cdFx0aWYgKHNraXBFeGlzdHMgJiYgdGhpcy5leGlzdHModykpXG5cdFx0e1xuXHRcdFx0cmV0dXJuIHRoaXM7XG5cdFx0fVxuXG5cdFx0aWYgKHBsdXMgJiYgcGx1cy5sZW5ndGgpXG5cdFx0e1xuXHRcdFx0Ly8gQHRvZG8gZG8gc29tZXRoaW5nXG5cdFx0fVxuXG5cdFx0dGhpcy5fYWRkKHsgdywgcCwgZiwgczogdHJ1ZSB9KTtcblxuXHRcdGxldCBzZWxmID0gdGhpcztcblxuXHRcdC8qKlxuXHRcdCAqIEB0b2RvIOmcgOimgeabtOiBsOaYjueahOS9nOazlSDnm67liY3nmoTlgZrms5Xlr6blnKjlpKrooKJcblx0XHQgKiBAQlVHIOWcqOS4jeaYjuWOn+WboOS4iyDkvLzkuY7kuI3mnIPmraPnorrnmoTmt7vliqDmr4/lgIvpoIXnm64g5aaC5p6c6YGH5Yiw6YCZ56iu5oOF5b2i6KuL5omL5YuV5re75Yqg57Ch57mB6aCF55uuXG5cdFx0ICovXG5cdFx0aWYgKDEgJiYgdGhpcy5vcHRpb25zLmF1dG9DamspXG5cdFx0e1xuXHRcdFx0bGV0IHdhID0gdGV4dF9saXN0KHcpO1xuXG5cdFx0XHR3YS5mb3JFYWNoKGZ1bmN0aW9uICh3Milcblx0XHRcdHtcblx0XHRcdFx0aWYgKHcyICE9IHcgJiYgIXNlbGYuZXhpc3RzKHcyKSlcblx0XHRcdFx0e1xuXHRcdFx0XHRcdHNlbGYuX2FkZCh7IHc6IHcyLCBwLCBmIH0pO1xuXHRcdFx0XHR9XG5cdFx0XHR9KTtcblxuXHRcdFx0Lypcblx0XHRcdGxldCB3Mjogc3RyaW5nO1xuXHRcdFx0dzIgPSBDamtDb252LnpoMmpwKHcpO1xuXG5cdFx0XHRpZiAodzIgIT0gdyAmJiAhdGhpcy5leGlzdHModzIpKVxuXHRcdFx0e1xuXHRcdFx0XHR0aGlzLl9hZGQoe3c6IHcyLCBwLCBmfSk7XG5cdFx0XHRcdC8vY29uc29sZS5sb2codzIpO1xuXHRcdFx0fVxuXG5cdFx0XHR3MiA9IENqa0NvbnYuY2prMnpodCh3KTtcblxuXHRcdFx0aWYgKHcyICE9PSB3ICYmICF0aGlzLmV4aXN0cyh3MikpXG5cdFx0XHR7XG5cdFx0XHRcdHRoaXMuX2FkZCh7dzogdzIsIHAsIGZ9KTtcblx0XHRcdFx0Ly9jb25zb2xlLmxvZyh3Mik7XG5cdFx0XHR9XG5cblx0XHRcdHcyID0gQ2prQ29udi5jamsyemhzKHcpO1xuXG5cdFx0XHRpZiAodzIgIT09IHcgJiYgIXRoaXMuZXhpc3RzKHcyKSlcblx0XHRcdHtcblx0XHRcdFx0dGhpcy5fYWRkKHt3OiB3MiwgcCwgZn0pO1xuXHRcdFx0XHQvL2NvbnNvbGUubG9nKHcyKTtcblx0XHRcdH1cblx0XHRcdCovXG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHRwcm90ZWN0ZWQgX2FkZCh7IHcsIHAsIGYsIHMgfToge1xuXHRcdHc6IHN0cmluZyxcblx0XHRwOiBudW1iZXIsXG5cdFx0ZjogbnVtYmVyLFxuXHRcdHM/OiBib29sZWFuLFxuXHR9KVxuXHR7XG5cdFx0bGV0IGxlbiA9IHcubGVuZ3RoO1xuXG5cdFx0dGhpcy5UQUJMRVt3XSA9IHtcblx0XHRcdHAsXG5cdFx0XHRmLFxuXHRcdFx0cyxcblx0XHR9IGFzIElUYWJsZURpY3RSb3c7XG5cblx0XHRpZiAoIXRoaXMuVEFCTEUyW2xlbl0pIHRoaXMuVEFCTEUyW2xlbl0gPSB7fTtcblxuXHRcdHRoaXMuVEFCTEUyW2xlbl1bd10gPSB0aGlzLlRBQkxFW3ddO1xuXHR9XG5cblx0cmVtb3ZlKHRhcmdldDogSVdvcmQgfCBJRGljdFJvdyB8IHN0cmluZylcblx0e1xuXHRcdGxldCB7IGRhdGEsIHBsdXMgfSA9IHRoaXMuX19oYW5kbGVJbnB1dCh0YXJnZXQpO1xuXG5cdFx0dGhpcy5fcmVtb3ZlKGRhdGEpO1xuXG5cdFx0cmV0dXJuIHRoaXNcblx0fVxuXG5cdHByb3RlY3RlZCBfcmVtb3ZlKHsgdywgcCwgZiwgcyB9OiBJV29yZClcblx0e1xuXHRcdGxldCBsZW4gPSB3Lmxlbmd0aDtcblxuXHRcdGRlbGV0ZSB0aGlzLlRBQkxFW3ddO1xuXHRcdGlmICh0aGlzLlRBQkxFMltsZW5dKVxuXHRcdHtcblx0XHRcdGRlbGV0ZSB0aGlzLlRBQkxFMltsZW5dW3ddXG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRoaXNcblx0fVxuXG5cdGpzb24oKTogSURJQ1Q8SVRhYmxlRGljdFJvdz5cblx0e1xuXHRcdHJldHVybiBjbG9uZURlZXAodGhpcy5UQUJMRSlcblx0fVxuXG5cdC8qKlxuXHQgKiDlsIfnm67liY3nmoQg6KGo5qC8IOWMr+WHulxuXHQgKi9cblx0c3RyaW5naWZ5KExGID0gXCJcXG5cIilcblx0e1xuXHRcdGxldCBzZWxmID0gdGhpcztcblxuXHRcdHJldHVybiBPYmplY3QuZW50cmllcyhzZWxmLlRBQkxFKVxuXHRcdFx0LnJlZHVjZShmdW5jdGlvbiAoYSwgW3csIHsgcCwgZiB9XSlcblx0XHRcdHtcblx0XHRcdFx0bGV0IGxpbmUgPSBzdHJpbmdpZnlMaW5lKFt3LCBwLCBmXSk7XG5cblx0XHRcdFx0YS5wdXNoKGxpbmUpO1xuXG5cdFx0XHRcdHJldHVybiBhXG5cdFx0XHR9LCBbXSlcblx0XHRcdC5qb2luKHR5cGVvZiBMRiA9PT0gJ3N0cmluZycgPyBMRiA6IFwiXFxuXCIpXG5cdFx0XHQ7XG5cdH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgVGFibGVEaWN0XG4iXX0=